definitions:
  build_config: &build_config
    instance_type: mac_mini
    max_build_duration: 60  

  versioning: &versioning
    flutter: stable
    xcode: latest
    cocoapods: default

  flavor_development_groups: &flavor_development_groups
    groups:
      - apple_credentials
      - apple_signing
      - development
  
  flavor_development_vars: &flavor_development_vars
    XCODE_SCHEME: "dev"
    BUNDLE_ID: "dev.app.simple.com"
    APP_STORE_ID: 1604368665

  flavor_staging_groups: &flavor_staging_groups
    groups:
      - apple_credentials
      - apple_signing
      - staging

  flavor_staging_vars: &flavor_staging_vars
    XCODE_SCHEME: "stage"
    BUNDLE_ID: "stage.app.simple.com"
    APP_STORE_ID: 1604368566

  flavor_production_groups: &flavor_production_groups
    groups:
      - apple_credentials
      - apple_signing
      - production
  
  flavor_production_vars: &flavor_production_vars
    XCODE_SCHEME: "prod"
    BUNDLE_ID: "app.simple.com"
    APP_STORE_ID: 1603406843

  cache: &cache
    cache_paths:
      - $FLUTTER_ROOT/.pub-cache
      - $HOME/.gradle/caches
      - $HOME/Library/Caches/CocoaPods

  scripts: &scripts
    - name: Set up keychain
      script: keychain initialize

    - name: Fetch signing files
      script: app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create

    - name: Use system default keychain
      script: keychain add-certificates

    - name: Set up code signing settings on Xcode project
      script: xcode-project use-profiles    

    - name: Add google-services.json
      script: echo $GOOGLE_SERVICE_ANDROID | base64 --decode > ./android/app/google-services.json

    - name: Add GoogleService-Info.plist
      script: echo $GOOGLE_SERVICE_IOS | base64 --decode > ./ios/Runner/GoogleService-Info.plist

    - name: Get packages
      script: flutter pub get

    - name: Generate autogenerated files
      script: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Analyze
      script: flutter analyze

    - name: Run tests
      script: flutter test --update-goldens
    
    - name: Build IOS with automatic versioning
      script: |
        flutter clean
        rm -f ios/Podfile.lock pubspec.lock
        rm -rf ios/Pods ios/Runner.xcworkspace
        flutter build ipa -t $MAIN_TARGET --release --build-name=1.0.1 \
        --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1))  \
        --dart-define=MY_APP_ENV=prod \
        --export-options-plist=/Users/builder/export_options.plist \
        --flavor $XCODE_SCHEME
    
    - name: Build Android (APK)
      script: flutter build apk -t $MAIN_TARGET

  publishing: &publishing
    app_store_connect:             
      apple_id: $APPLE_ID    
      password: $APPLE_APP_SPECIFIC_PASSWORD

    email:
      recipients:
        - illia.s@smplt.net
        - vladimir.m@smplt.net
        - vovkamedvedev5@gmail.com
        - novichikhin.au@gmail.com
        - andrey.p@smplt.net
        - andrey.v@smplt.net
        - danil.s@smplt.net
        - denis.m@smplt.net
        - ruslan.s@smplt.net
        - ruslan.skyba.ser@gmail.com
      
      notify:
        success: true
        failure: true

    scripts:
      - name: Post-publish script
        script: echo 'Published Successfully!'

  artifacts: &artifacts
    - build/**/outputs/**/*.aab
    - build/**/outputs/**/*.apk
    - build/ios/ipa/*.ipa
    - /tmp/xcodebuild_logs/*.log
    - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.dSYM
    - flutter_drive.log        

workflows:
  flavor_development_target_stage:
    name: Flavor (Development) Target (Stage)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_stage.dart"
        <<: *flavor_development_vars

      <<: *flavor_development_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts

    triggering:
      branch_patterns:
        - pattern: '*'
          include: false
          source: false
      cancel_previous_builds: false  

  flavor_development_target_production:
    name: Flavor (Development) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_development_vars

      <<: *flavor_development_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts

    triggering:
      branch_patterns:
        - pattern: '*'
          include: false
          source: false
      cancel_previous_builds: false

  flavor_staging_target_production:
    name: Flavor (Staging) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_staging_vars

      <<: *flavor_staging_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts

    triggering:
      branch_patterns:
        - pattern: '*'
          include: false
          source: false
      cancel_previous_builds: false
  
  flavor_production_target_production:
    name: Flavor (Production) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_production_vars

      <<: *flavor_production_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts

    triggering:
      branch_patterns:
        - pattern: '*'
          include: false
          source: false
      cancel_previous_builds: false