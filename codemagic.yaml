workflows:
  development-workflow:
    name: Development Workflow
    instance_type: mac_mini
    max_build_duration: 60

    environment:
      vars:
          GOOGLE_SERVICE_ANDROID: Encrypted(Z0FBQUFBQmd2MkVpY1o3bVdSRXNZWGE0LTJ1MXdNMEMwZ1Axb09VVTkyLUhYZGtiQ2x4ZWNYajFjQWxWbERhemJCQjRlZGxKMWtpZ0lkR1VGZ0lsSVRkZTdnc0NhdHhZa3RRaVlGWDBGUnFPNTduU0k2dHlzRXFXWUpVTHUzMkZoNlU0TDNLeERRMVhsaDlMRUhIbEx5elVnODY2TW1Vd1NTaXNmN3FjdjlqMjdxZlBqNVNJNmZnamh2cVRjei1DWndwTFFNWTBMSkI4Y0toWEdYNHI2QWw5cjFtTl9PSzQzRklQLTNiUDdQck0tYTBLTFNmVkhlOXhLMkY2dDh0M1RPSDduRmhlZFZTOWZtMDk2ZW95LVlZVHIyRGJNVHVxem5zb2haYXRGeXEwT2UwZG9FTmkwbjAxcWJoQlVYRVhvWXdyMkxXMmF2QVladllzQXhMUjVQUW9Oc3FZdjhLd0MxOWlkRlgybERBQXRlNWRLMk50VVB3dm5MUXl3TV92ZWNiVWpaeTRIajRJak9qTkxyLUpmTzF0Y3ZPekhtZDlsN1ZDNGh3YzQ5LTl5aWx4enFoZE9uR1pDWVBPQTNuc0xCcDJsanFxWnlqejk5OHpuWnVSX2RRVXl3Vldvd1ZOaXdpZUZrTDQyTnAzZVc4d3JPcDVsX1QzZnVOaTBDYUt1OTJWbFhOSW1LSWNUZF91TGw3M3YyalMtVlRkYXZTQVdpeGpQVXcyS1JOR2pHRnd0bFBHdEFQSEY1ek1EeDQ4ekVJeEJ1R3o4cDFNOFh3V2dUSXFoVmxOaTF3S0xubGcxQVFVQURoVGhtbmczcW9Oa0NIWEVIVnR2M3V6MVBSRTFxbEN0d0ZQcnMtTGxvcllaZlNlUE9Ld0tTdmdQVi1ycVNueGF5MTlpVmowZmpNOVRHT0x0eC1YczhyME5SdHkxcjhMUkxOeVQ3elR6ZVBKaHNnUWtBRzR4NDlldmpHZU5rbE1VeGhKRzdlckppRFZmTGdOSk1fU1A3b1NLREt5b3JKakU5MHcwUWF1WURkckU4YW5wOXI1NGFOVTk1VUw2ZjhqQ2RKVEFJVmRwNlBsWlpjaF9ZZmlDWnJMdk02d3h6djJSYkNOdFVHN1pNSUxnbUVIZmVhREt0bERxZzFPWTRwcUlwMDR1LWg3YS0tUll2MHE0QW8xZFk0T2E2MjNiV2tXandsTFh6N180UDZnLTJGUW1CbU1FZFY2WlphUjM1U0Z6UmQtOHhTbVQ4QWprbzFWdEtOWlNwTGVjYzUwQm5vMC1pMmFPYS04VTU4YnFQYnA2TVdhdGFQWWtLaW5jeEsyaVhkTV9rWnZDSC1mZzhrS3ZEc1g3Z3Vmd3VzWG5sMXQ4eVd5NndsZGtjaGc4VktBcG8zTzhXTHVSWUM1SDZQaGVPVEJ6cmJtUFFWSS1uX2Vock8yZENWRkk1LTNqYlVvUTNTeXVERDlTQTdEOTBOM0NPSXVZelVpS0lYUkk5TDR3b0JTblQzOTZRZ2JJZWVCOEVPenRhSEJvZl9NdG5ubUZFZnRCRENoQmd0ZVh2TEFWSTBWbzVWdHNwNkQydkZkQlRReEhsTU83cXZHbHFvWXhlc0RhRm9FTHBYSHpVOEkyLVpaNFRCazVkeU55aElnUDFCMVJFU3FhdFdvV0duT3JldmRWQk1jbl9WZnRXQ3FvWW8wbFV6OHoySmtPNzB6MXZ1OEhuU1pBVkRHX2RCdGRNVmxfNDJDZmI4VkxwSjRrMm9VM2NLTDB1ajdXTWpNM05nWDlCbkpOY0VRZ04yT1lKcWxRRUp0V0kwclNYWFBiX1U5Q25nR0VRWHo5Q1VmZVV0OGM3T1dpRkdVT1I4eVBtNmhLMzEwbFQ4Z2NKaEw3SXh1VUlZdGg4N1JNZjNiV3FuOXVROHd0SEM1SjUyWU9uMDBlUUk0WTFUYXJqeVZpUFhYc2VNMmVYSXo5aWd5N1RLWGV5d0N4cnhvcjVoSVBycWtJQ1BOQlBUVlNoU3lvRkdMVWo3SmlmenQ4UGlpcVJ0MU1NOVJrV0JNS1ZOQ1NYZENZdTB6WDUwUjlIU2o3M1VqYXdoMzVlZ0pDUzBISFEzbTV6b3V5X0ROMExJNEUxWDZiUVp3TGoyQUdZMHpRbVZVa280MjU0TV9Fd0J6MlhlNFRPSU1YSTNsQTVZd1BjYW5ycjEtR2RfNVpZWlB6NzRzcFlaRG93M3hSWFBabU41em1TXzEzWlRmMTRPOUM1cFpGM1NMd25ib2F4Q3hMeEdObHJ1SDJyLWZMdXpYeFllaEtSV2UxYVZSNTNzNUlGVHFJS01wR0J4YURmV1VyTmlXdllhclNmckJxZVNlWU52bXc4TlQ3TEp6ZmZEYnozZ24wam44RkNKLWtlcHVVYXBYVGE4RGhrMjBhRmhEdGVneWNTQy1kWjBJNlRGXzBQMXpsb21ZdER1SjBhZDJKSlRpQlBpM2lxTi1oSTFWSkp3MDZwenpSNzdMYlgzeDNKMHBRQnN1aDctSTZKN2JwdXUwU2p2RWMzNmcwOUtqeTVKRzRiMFVLWE8zZm85NEhXVmcwX1pXMG5WYWFpdUFYalJ5aHR4NUF6eG1WV0pDVmFFd1BlbWY3N2h0OWVhbFUyaGs3VjQzSTB5NUdxS0hGQnJYVkZQaVB5WHdqTWFvRGNvbzVNeG5RaE8xS1pLUnN1c1lXd0FFcFRRYkZnMkQtbWpSX3JDR1RMWTBFS05oLVQ0X0NyODBOS2g2S1l6cjljM1pja29kVS1iR2Z2S09xYjNaSWFUb1NhUEo3QkxHNm1CVDRGYWlEY3BQcXB1UUpmQzZxRzhtRTFIYlNtN2xKOXFOUHJhMlJ3aXUtNTRKZGVrRHNqcjd4bUVpdV9vYWZieVBWaFNBdm5sRXFOQ2RnN0cyQmVyYVJPbDNiSDRuVEdBeDBpcmNZMk9kVzhBTEF6QWhtWVFSakd2a052ekhFZXUzYmk3RUZ0YVVZZnhzOGFHd1dEY1JwREt6THVqZTJSaFNZaFhLcTB2Mk8xZFE5X3VzN0h6UnJ5RDF5ZFg4WW1WUHp5Tzh4ZU5YM21wT3lFWnVlb3d4OTI5UUxHU01WdHpaUkFXLV9uUUkwWnFETUlMdlNSX3ZQelBTUDM5WEgwND0=)
          BUNDLE_ID: "com.jetwallet.Jetwallet"
          APP_STORE_ID: 1571266508
          APPLE_ID: Encrypted(Z0FBQUFBQmd3TGZUSDVTOFR5LWRITjJBTm9TbDUwbGdJdGpyN09jdWNFZjVPUGp0SVU2NUJIQTN0LUhNYndGVnhHdk41TTl1aXljT3dOc1ZSTlVobnVFeG9ZN3dIMEEyR2d6Y1VwZnBvWFdGS3hQY0xNWXFDMGs9)
          APPLE_APP_SPECIFIC_PASSWORD: Encrypted(Z0FBQUFBQmd3TG13dm9vWURQcXNMRjgtVGs4UTNSU1h4dXN1cmRTSy1wX3lCRV9aay1sRkthNHZHV1kxZU1iYzRNT1lpS05DWFZMeC1XemxrVzZrZU1IdHdHVGhxSE1Gc3lLY2M0cy1BYVREVG5fZDh1TkdrXzA9)
      
      flutter: stable
      xcode: latest
      cocoapods: default

    cache:
      cache_paths:
        - ~/.pub-cache

    triggering:
      branch_patterns:
        - pattern: 'master'
          include: true
          source: false
        - pattern: 'develop'
          include: true
          source: false
        # TODO Delete after configuring ci
        - pattern: '*'
          include: true
          source: true
      cancel_previous_builds: false

    scripts:
      - name: Set up keychain
        script: keychain initialize
        
      - name: Fetch signing files
        script: app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create

      - name: Use system default keychain
        script: keychain add-certificates

      - name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles    

      - name: Install pods
        script:  |
          find . -name "Podfile" -execdir pod install \;

      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist

      - name: Add google-services.json
        script: echo $GOOGLE_SERVICE_ANDROID | base64 --decode > ./android/app/google-services.json

      - name: Get packages
        script: flutter pub get

      - name: Generate autogenerated files
        script: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze
        script: flutter analyze

      - name: Run tests
        script: flutter test --update-goldens

      # - name: Build Android (APK)
      #   script: flutter build apk

    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/*.apk
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      app_store_connect:             
          apple_id: $APPLE_ID    
          password: $APPLE_APP_SPECIFIC_PASSWORD

      email:
        recipients:
          - illia.s@smplt.net
        notify:
          success: true
          failure: false
      
      scripts:
        - name: Post-publish script
          script: echo 'Published Succesfully!'
    
