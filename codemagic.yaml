workflows:
  development-workflow:
    name: Development Workflow
    instance_type: mac_mini
    max_build_duration: 60

    environment:
      vars:
          XCODE_WORKSPACE: "Runner.xcworkspace"
          XCODE_SCHEME: "Runner"    
          GOOGLE_SERVICE_ANDROID: Encrypted(Z0FBQUFBQmd2MkVpY1o3bVdSRXNZWGE0LTJ1MXdNMEMwZ1Axb09VVTkyLUhYZGtiQ2x4ZWNYajFjQWxWbERhemJCQjRlZGxKMWtpZ0lkR1VGZ0lsSVRkZTdnc0NhdHhZa3RRaVlGWDBGUnFPNTduU0k2dHlzRXFXWUpVTHUzMkZoNlU0TDNLeERRMVhsaDlMRUhIbEx5elVnODY2TW1Vd1NTaXNmN3FjdjlqMjdxZlBqNVNJNmZnamh2cVRjei1DWndwTFFNWTBMSkI4Y0toWEdYNHI2QWw5cjFtTl9PSzQzRklQLTNiUDdQck0tYTBLTFNmVkhlOXhLMkY2dDh0M1RPSDduRmhlZFZTOWZtMDk2ZW95LVlZVHIyRGJNVHVxem5zb2haYXRGeXEwT2UwZG9FTmkwbjAxcWJoQlVYRVhvWXdyMkxXMmF2QVladllzQXhMUjVQUW9Oc3FZdjhLd0MxOWlkRlgybERBQXRlNWRLMk50VVB3dm5MUXl3TV92ZWNiVWpaeTRIajRJak9qTkxyLUpmTzF0Y3ZPekhtZDlsN1ZDNGh3YzQ5LTl5aWx4enFoZE9uR1pDWVBPQTNuc0xCcDJsanFxWnlqejk5OHpuWnVSX2RRVXl3Vldvd1ZOaXdpZUZrTDQyTnAzZVc4d3JPcDVsX1QzZnVOaTBDYUt1OTJWbFhOSW1LSWNUZF91TGw3M3YyalMtVlRkYXZTQVdpeGpQVXcyS1JOR2pHRnd0bFBHdEFQSEY1ek1EeDQ4ekVJeEJ1R3o4cDFNOFh3V2dUSXFoVmxOaTF3S0xubGcxQVFVQURoVGhtbmczcW9Oa0NIWEVIVnR2M3V6MVBSRTFxbEN0d0ZQcnMtTGxvcllaZlNlUE9Ld0tTdmdQVi1ycVNueGF5MTlpVmowZmpNOVRHT0x0eC1YczhyME5SdHkxcjhMUkxOeVQ3elR6ZVBKaHNnUWtBRzR4NDlldmpHZU5rbE1VeGhKRzdlckppRFZmTGdOSk1fU1A3b1NLREt5b3JKakU5MHcwUWF1WURkckU4YW5wOXI1NGFOVTk1VUw2ZjhqQ2RKVEFJVmRwNlBsWlpjaF9ZZmlDWnJMdk02d3h6djJSYkNOdFVHN1pNSUxnbUVIZmVhREt0bERxZzFPWTRwcUlwMDR1LWg3YS0tUll2MHE0QW8xZFk0T2E2MjNiV2tXandsTFh6N180UDZnLTJGUW1CbU1FZFY2WlphUjM1U0Z6UmQtOHhTbVQ4QWprbzFWdEtOWlNwTGVjYzUwQm5vMC1pMmFPYS04VTU4YnFQYnA2TVdhdGFQWWtLaW5jeEsyaVhkTV9rWnZDSC1mZzhrS3ZEc1g3Z3Vmd3VzWG5sMXQ4eVd5NndsZGtjaGc4VktBcG8zTzhXTHVSWUM1SDZQaGVPVEJ6cmJtUFFWSS1uX2Vock8yZENWRkk1LTNqYlVvUTNTeXVERDlTQTdEOTBOM0NPSXVZelVpS0lYUkk5TDR3b0JTblQzOTZRZ2JJZWVCOEVPenRhSEJvZl9NdG5ubUZFZnRCRENoQmd0ZVh2TEFWSTBWbzVWdHNwNkQydkZkQlRReEhsTU83cXZHbHFvWXhlc0RhRm9FTHBYSHpVOEkyLVpaNFRCazVkeU55aElnUDFCMVJFU3FhdFdvV0duT3JldmRWQk1jbl9WZnRXQ3FvWW8wbFV6OHoySmtPNzB6MXZ1OEhuU1pBVkRHX2RCdGRNVmxfNDJDZmI4VkxwSjRrMm9VM2NLTDB1ajdXTWpNM05nWDlCbkpOY0VRZ04yT1lKcWxRRUp0V0kwclNYWFBiX1U5Q25nR0VRWHo5Q1VmZVV0OGM3T1dpRkdVT1I4eVBtNmhLMzEwbFQ4Z2NKaEw3SXh1VUlZdGg4N1JNZjNiV3FuOXVROHd0SEM1SjUyWU9uMDBlUUk0WTFUYXJqeVZpUFhYc2VNMmVYSXo5aWd5N1RLWGV5d0N4cnhvcjVoSVBycWtJQ1BOQlBUVlNoU3lvRkdMVWo3SmlmenQ4UGlpcVJ0MU1NOVJrV0JNS1ZOQ1NYZENZdTB6WDUwUjlIU2o3M1VqYXdoMzVlZ0pDUzBISFEzbTV6b3V5X0ROMExJNEUxWDZiUVp3TGoyQUdZMHpRbVZVa280MjU0TV9Fd0J6MlhlNFRPSU1YSTNsQTVZd1BjYW5ycjEtR2RfNVpZWlB6NzRzcFlaRG93M3hSWFBabU41em1TXzEzWlRmMTRPOUM1cFpGM1NMd25ib2F4Q3hMeEdObHJ1SDJyLWZMdXpYeFllaEtSV2UxYVZSNTNzNUlGVHFJS01wR0J4YURmV1VyTmlXdllhclNmckJxZVNlWU52bXc4TlQ3TEp6ZmZEYnozZ24wam44RkNKLWtlcHVVYXBYVGE4RGhrMjBhRmhEdGVneWNTQy1kWjBJNlRGXzBQMXpsb21ZdER1SjBhZDJKSlRpQlBpM2lxTi1oSTFWSkp3MDZwenpSNzdMYlgzeDNKMHBRQnN1aDctSTZKN2JwdXUwU2p2RWMzNmcwOUtqeTVKRzRiMFVLWE8zZm85NEhXVmcwX1pXMG5WYWFpdUFYalJ5aHR4NUF6eG1WV0pDVmFFd1BlbWY3N2h0OWVhbFUyaGs3VjQzSTB5NUdxS0hGQnJYVkZQaVB5WHdqTWFvRGNvbzVNeG5RaE8xS1pLUnN1c1lXd0FFcFRRYkZnMkQtbWpSX3JDR1RMWTBFS05oLVQ0X0NyODBOS2g2S1l6cjljM1pja29kVS1iR2Z2S09xYjNaSWFUb1NhUEo3QkxHNm1CVDRGYWlEY3BQcXB1UUpmQzZxRzhtRTFIYlNtN2xKOXFOUHJhMlJ3aXUtNTRKZGVrRHNqcjd4bUVpdV9vYWZieVBWaFNBdm5sRXFOQ2RnN0cyQmVyYVJPbDNiSDRuVEdBeDBpcmNZMk9kVzhBTEF6QWhtWVFSakd2a052ekhFZXUzYmk3RUZ0YVVZZnhzOGFHd1dEY1JwREt6THVqZTJSaFNZaFhLcTB2Mk8xZFE5X3VzN0h6UnJ5RDF5ZFg4WW1WUHp5Tzh4ZU5YM21wT3lFWnVlb3d4OTI5UUxHU01WdHpaUkFXLV9uUUkwWnFETUlMdlNSX3ZQelBTUDM5WEgwND0=)
          GOOGLE_SERVICE_IOS: Encrypted(Z0FBQUFBQmd3THd1SEdOckQ0RXFUanU0eXI5WFV1SVFyN1lWeHFjTDg3Njc0NXpaWTVLQ2F6c21vYU9Ocl80MU5oZS1EOXg0eWVjY2xFWjRnMkNoUUpJaWtPbTg3c1labUVkdXl2QTJZTTdkOTEtMXF4Y3dJMGZCOEp5SEI0MkI1Tms2RnFSRVpRQzNZYldyUjJYR3oybHB3VmxOY2dfZFhnUGRoZGRoaUI0VGQzUXNxSlVGd3Q1Z29zLUFUS0lpUkJ2MXJmcnpzRkFiR3F5MVZIS1lHclVDN2RJV2JjOEtRZGFBQWFTWTBNYUV0bF8xb1FocmRCVUdlTXRHTlBRQm5rWkRxNHRBMnMyR1ZIX3c2YmVhcXBWME0yMGVkZzRxVVFHZzdTbVBaOW1OSEVSOHdBeXFQZ0w5YW05NU9xRVF4VlVETko5NEV3cnN0TUN2Ym1nT2VtLW5GMmhsMDdlcE1PZDBUY0JjcEhVRFZmbmRLdkNiNjVFdEtmVk9LR2VJYi1FbEpRVVhlZFpIekNwSFRHeENZSnB2V3NBUGxTeHlqbVNubTM5WXlaeGVtdl8yZVRvaGxGaHJiUzRFNFlvS08xT084SWpFZ05jaERFS1Y2ZnVCYTljYkhUV3BibHVvMTFlX2hxMzRBQ0lKa013dVQtV2lZUjlfMFNIbEg0Z2dad3pjWVlOVHNDb3RBZldtX2NOV18xcVk1Y0Y5ekNUczRGN2VYVWJpVWlBaGY5Y21jREEtSFNSSHNJMk4xZUd3TjRCWVFnSUlJTHMzTHJJQ1kwX3Jpek9LODJRbmRVYXR2R1huV1VSck9nTmdDcFdfYTVaVEtFSV8tc1ZnMmZBVFpWYkRxWnFWUndHOW5HZmg1RGhYZ2pOY3lmcFJXaGtNbUh5MGVCcmhVVnFaZXdEajFfY3RtN0hZZ3RXRDhNVF9pSzh1ZUhmdlNteENFSkpGaHJjWkZCR3d6aGZmVVAwVGNMdHpOZkFYNUtEbTIycUcwU1JtNzNCbEYwMXFuTHV4bkt2Nmtkc1gySTdkQkhQZjVhV1FLOG5hV09vRkRPRVVtT2V2ODF4V3Zhbmx6a1lEcFpuUE5zc2IxamtoaEVvZnZraGtNU0gtNmNOanlFMXZnRHBmVWhZQUhOR1lmTUJLWlpMT1Zyb2N3UUVwMWhNczZxZzl2Wk5YWU8yY3NBOERKeWxNQkh0dVFCQWRVMmRIOG9pUHd6OXpydk1EX00wQWpGaVVFRlIzYWhLR2pSRjBTbzRsdEN4M2JsaVZCR0dqVjhQM2NBQU9yUVdKMnVORFpZb2dMNGwwMFczWHJIUlRHdDNtTVp0b3NFazR2NWdEdW9TdlA4WG5sb296ajRSRXQ3ZE0yeVU4dzZuZmQ0MnVmajRNdUhXRmlrZTRQUEN3R0hZS2pDVHowaFBWTkprMG1xY1lTQ3hnQ1lPaWJveEpxYkM3SVhBemRNVFBRNjJmcnlvWHJBTHU4MENycmkyOUNTRnV3RDVCWmVzSjVHcUdjVU5mWktDNHgycTFNVUNUWnBQWS14SHpPQ3BxOHNDazNUTm82SFZwc1ZCZmFBblh0WjcyWEVrRmg5bmFpeWdWWWtYUTNEOVlubzdSZHlySWJXamViS1lyODlUOUxGNnpkSmFUOV9GcHJGejVzbU9iVjZYaVMtSU1PaE9WbUlFX1dEZ3Z3RmxiM2R2TXRwN3RoMHdpZlg1NnJmTnVIN2pod29odEdZTmRBcWRfa3pzejVGN2E2cnpWQzNMUDc2ekt2NnlqZXJYb1JRbDdid0F6NE1zRGlDbVdSOHhVY25GeGdvMy1BLWxiQkNTVDRIRG91cXJzX21PYlV4YktMeVFNbXNzRkJycmxHV3RSbUVyUlRLSHVqem1xaUVYWXpxTll0TnJPUlZWdlRoWFI0ZDZjck1rTnJoZU1wcjFpc2NxVjk2NDg0VTZ1LVFqLWp4YzhPZGwyd2xtejFnbDdXRVZLQ3pKT05wZFprQkV4XzllUy1BcnlKLXRnS1JFaW5PSmtCUjJEVnIxWmZvcWl1aHlzb1RQOXE1ejVzZDBVMUN2WUNQdDRYYjNRaW5yOWQ5LWFJaWZ3dzdLSk1KdEZKYU93blZwTmtiN2VpMUVDZ0ZST3dtdC1BclJCUnAyV1NSWWZSRm40RUlVOWV0SXlOXzktSnJZUlNZMDBnMnAzZGRLdF9jZ2tqaklueFFaeFNseF81R3RTd3hGWkIyUUktRlU0RlBnWUQwRFY4ODQtOGwwTWhtQjNmcllaOWt5TlpGUWcyVjV5Ny1ncHBLLUpheXZ2Tm5IMnZqNlNJcjU5blN2OVRlcUlueDktQl8zSlBfS2N1TTdSRzgwSDZ0dGc2WkxFc2Vtb2VjampaVG82M3lLYmNKNmpqREhiRnh6UUVENGsxci1EajloXzhkUkJlM1RWYkZsZlpHaG02Wm5vLTBZaU9MUHBZWngxb3pDeU4tWWxjeThycGlxbmhmOE4xXzdsMXk3RF8xdFhnTHBmRmQ4b1l5N0h5MElQZ0RfbDA5LUNZcUdZc0g1WUNZMXRzd1dmTmlZRllmMmN4TWJYdkxDMGVGako4YWZiazRVSm5sRTdtQVdTSmxrSlk5ajBmbWE4bF9McDZCZXNqV2llTVR6ZEMtRmpTdXJWOG1TM25DREw2UFBSUlpsVVZmRmhwenlLeFRMMF9jaDkxMURqS2ZsbjRnNWNDVU15NjNuVzAweFBuVWtNU1VfVW1FZmg=)
          BUNDLE_ID: "com.jetwallet.Jetwallet"
          APP_STORE_ID: 1571266508
          APPLE_ID: Encrypted(Z0FBQUFBQmd3TGZUSDVTOFR5LWRITjJBTm9TbDUwbGdJdGpyN09jdWNFZjVPUGp0SVU2NUJIQTN0LUhNYndGVnhHdk41TTl1aXljT3dOc1ZSTlVobnVFeG9ZN3dIMEEyR2d6Y1VwZnBvWFdGS3hQY0xNWXFDMGs9)
          APPLE_APP_SPECIFIC_PASSWORD: Encrypted(Z0FBQUFBQmd3TG13dm9vWURQcXNMRjgtVGs4UTNSU1h4dXN1cmRTSy1wX3lCRV9aay1sRkthNHZHV1kxZU1iYzRNT1lpS05DWFZMeC1XemxrVzZrZU1IdHdHVGhxSE1Gc3lLY2M0cy1BYVREVG5fZDh1TkdrXzA9)
          APP_STORE_CONNECT_ISSUER_ID: Encrypted(Z0FBQUFBQmd3TVF4Sjg5ZTQwanRkWlkySmQxYlBGOGJ4VU5yT3A5YnNHSjgxVVZLbklueWRXMm9zRGxZQTQzd1RKSUhiRUdIdmtTdXJMVUFPYnFjRkRoaHFCM2pIVDEwaFhpcVI4MzhrS21wUUFteWpiM1IzekZQSWZwdDhnOVhzRlc5Y3dISTk1NEc=)
          APP_STORE_CONNECT_KEY_IDENTIFIER: Encrypted(Z0FBQUFBQmd3TVFhNWFWV1loWDkyNlU1cDkxSUlNLV9OQVRSbURVN2o3RndUWkRsdUZSdDlCdXJEUHI3eGx2aFVQNEZNRi13Smw2aEVjS3RERTF3MEdRZ0pSNHdKR1E1REE9PQ==)
          APP_STORE_CONNECT_PRIVATE_KEY: Encrypted(Z0FBQUFBQmd3TkI2Wk4wTjRWTmd1a0VDMThNcmdmQXE4dThEcUVmbUhfX0h2ZWFLSnZVcTc5Tkp1SmNzOW5KX2lVX0hnNG5vX2ZkUDhvR2dXTENhWHdndVBDbGZHb1gzUWhZeTZkVWMwZy1DMHdVWDVpM1c0eGt1QlBZRERvT29tRjlXd1JIQUM1dGhVVG1nNndET0d0ZGtDdnhycHc4aGR3blZ3SnkwR29FbUlYSHRPN1ZUaVdCYkpSUHFyWGJpQWNKM083aldXTE9MYjN0cndTLVh1dVZIUkZQdG5QQmFzSTFfRlpsMDNWZ2VGcEFrczQ4QklLY1JHZmFNdlNEVDF3YnpGX1FrMHNfc0Z1aTk1SXE5NlZsMGxjMWRXbFNpSmFncXp1R0F6WFJ0RjBZeG84aTZkMDktMjRmQ2drc0Zkajl1cTl3dEJodEJSaUUtQnNJb09fWnpaaXREeXZySWQ1Rzg2WlNsZXRJOFYyYW9iZnk2Zmx2eWZzNmptWWpTdVBCX2hvOHBRX3VTRUxoZkFtZzd3OE1vNWV0Q3k0dldaaGE3SkF0QUpXQzR1Y3dKa19QaW1pMGNuYzQxVUZQc2prMEl4QWlHMDVXUzc2cDdKRmFaWDMwTmVxZjdYVFgya3FUMmZwdDN6T2pZVGVCaE5LaXdnaTQ5WWkzd2FqSHNJMFlONkxFZWdNM2Z4MURHN2tseUQ1NHd3TjdtMnM4TGJBPT0=)

      flutter: stable
      xcode: latest
      cocoapods: default

    cache:
      cache_paths:
        - ~/.pub-cache

    triggering:
      branch_patterns:
        - pattern: 'master'
          include: true
          source: false
        - pattern: 'develop'
          include: true
          source: false
        # TODO Delete after configuring ci
        - pattern: '*'
          include: true
          source: true
      cancel_previous_builds: false

    scripts:
      - name: Set up keychain
        script: keychain initialize
        
      - name: Fetch signing files
        script: app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create

      - name: Use system default keychain
        script: keychain add-certificates

      - name: Set up code signing settings on Xcode project
        script: xcode-project use-profiles    

      - name: Add google-services.json
        script: echo $GOOGLE_SERVICE_ANDROID | base64 --decode > ./android/app/google-services.json
      
      - name: Add GoogleService-Info.plist
        script: echo $GOOGLE_SERVICE_IOS | base64 --decode > ./ios/Runner/GoogleService-Info.plist

      - name: Get packages
        script: flutter pub get

      - name: Generate autogenerated files
        script: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Analyze
        script: flutter analyze

      - name: Run tests
        script: flutter test --update-goldens

      - name: Install pods
        script:  |
          find . -name "Podfile" -execdir pod install \;

      - name: Flutter build ipa and automatic versioning
        script: |
          flutter build ipa --release \
          --build-name=1.0.0 \
          --build-number=$(($(app-store-connect get-latest-testflight-build-number "$APP_STORE_ID") + 1)) \
          --export-options-plist=/Users/builder/export_options.plist

      # - name: Build Android (APK)
      #   script: flutter build apk

    artifacts:
      - build/**/outputs/**/*.aab
      - build/**/outputs/**/*.apk
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      app_store_connect:             
          apple_id: $APPLE_ID    
          password: $APPLE_APP_SPECIFIC_PASSWORD

      email:
        recipients:
          - illia.s@smplt.net
        notify:
          success: true
          failure: false
      
      scripts:
        - name: Post-publish script
          script: echo 'Published Succesfully!'
    
