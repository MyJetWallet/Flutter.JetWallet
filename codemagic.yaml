definitions:
  build_config: &build_config
    instance_type: mac_mini
    max_build_duration: 60 

  # TOOD rename GOOGLE_SERVICE_ANDROID to ANDROID_FIREBASE_SECRET 
  # and GOOGLE_SERVICE_IOS to IOS_FIREBASE_SECRET

  versioning: &versioning
    flutter: stable
    xcode: latest
    cocoapods: default

  flavor_development_groups: &flavor_development_groups
    groups:
      - google_credentials
      - apple_credentials
      - apple_signing
      - development
      - keystore_credentials_development
  
  flavor_development_vars: &flavor_development_vars
    FLAVOR: "dev"
    BUNDLE_ID: "dev.app.simple.com"
    APP_STORE_ID: 1604368665
    FIREBASE_APP_ID: 1:440447150598:android:a31f38c8dd14cb677fb187

  flavor_staging_groups: &flavor_staging_groups
    groups:
      - google_credentials
      - apple_credentials
      - apple_signing
      - staging
      - keystore_credentials_staging

  flavor_staging_vars: &flavor_staging_vars
    FLAVOR: "stage"
    BUNDLE_ID: "stage.app.simple.com"
    APP_STORE_ID: 1604368566
    FIREBASE_APP_ID: 1:709845370864:android:5dd30cc672286c1781ff35

  flavor_production_groups: &flavor_production_groups
    groups:
      - google_credentials
      - apple_credentials
      - apple_signing
      - production
      - keystore_credentials_production
  
  flavor_production_vars: &flavor_production_vars
    FLAVOR: "prod"
    BUNDLE_ID: "app.simple.com"
    APP_STORE_ID: 1603406843
    FIREBASE_APP_ID: 1:403762259621:android:e4cb6f9d00b51a0d020f4c

  cache: &cache
    cache_paths:
      - $FLUTTER_ROOT/.pub-cache
      - $HOME/.gradle/caches
      - $HOME/Library/Caches/CocoaPods

  scripts: &scripts
    - name: Set up keychain
      script: keychain initialize

    - name: Fetch signing files
      script: app-store-connect fetch-signing-files $BUNDLE_ID --type IOS_APP_STORE --create

    - name: Use system default keychain
      script: keychain add-certificates

    - name: Set up code signing settings on Xcode project
      script: xcode-project use-profiles    

    - name: Add google-services.json
      script: echo $GOOGLE_SERVICE_ANDROID | base64 --decode > ./android/app/google-services.json

    - name: Add GoogleService-Info.plist
      script: echo $GOOGLE_SERVICE_IOS | base64 --decode > ./ios/Runner/GoogleService-Info.plist

    - name: Get packages
      script: flutter pub get

    - name: Generate autogenerated files
      script: flutter pub run build_runner build --delete-conflicting-outputs

    - name: Analyze
      script: flutter analyze

    - name: Run tests
      script: flutter test --update-goldens
    
    - name: Build IOS with automatic versioning
      script: |
        flutter clean
        rm -f ios/Podfile.lock pubspec.lock
        rm -rf ios/Pods ios/Runner.xcworkspace
        flutter build ipa --release --target=$MAIN_TARGET --flavor=$FLAVOR \
        --build-name=$(git describe --tags --abbrev=0) --build-number=$PROJECT_BUILD_NUMBER \
        --dart-define=MY_APP_ENV=prod \
        --export-options-plist=/Users/builder/export_options.plist \

    - name: Decode keystore
      script: echo $FCI_KEYSTORE | base64 --decode > $FCI_KEYSTORE_PATH
    
    - name: Build Android (AAB)
      script: |
        flutter build appbundle --release --target=$MAIN_TARGET --flavor=$FLAVOR \
        --build-name=$(git describe --tags --abbrev=0) --build-number=$PROJECT_BUILD_NUMBER
    
    - name: Build Android (APK)
      script: |
        flutter build apk --release --target=$MAIN_TARGET --flavor=$FLAVOR \
        --build-name=$(git describe --tags --abbrev=0) --build-number=$PROJECT_BUILD_NUMBER

  publishing: &publishing
    app_store_connect:             
      apple_id: $APPLE_ID    
      password: $APPLE_APP_SPECIFIC_PASSWORD

    google_play:
      credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
      track: alpha
      in_app_update_priority: 0
      submit_as_draft: true

    firebase:
      firebase_service_account: $FIREBASE_SERVICE_ACCOUNT
      android:
        app_id: $FIREBASE_APP_ID
        groups: 
          - main_group
        artifact_type: 'apk'

    email:
      recipients:
        - illia.s@smplt.net
        - vladimir.m@smplt.net
        - vovkamedvedev5@gmail.com
        - novichikhin.au@gmail.com
        - andrey.p@smplt.net
        - andrey.v@smplt.net
        - danil.s@smplt.net
        - denis.m@smplt.net
        - ruslan.s@smplt.net
        - ruslan.skyba.ser@gmail.com
      
      notify:
        success: true
        failure: true

    scripts:
      - name: Android post-publish script
        script: jarsigner -verify -verbose -certs $FCI_BUILD_OUTPUT_DIR/*.aab

  artifacts: &artifacts
    - build/**/outputs/**/*.aab
    - build/**/outputs/**/*.apk
    - build/ios/ipa/*.ipa
    - /tmp/xcodebuild_logs/*.log
    - flutter_drive.log    
  
  dev_triggering: &dev_triggering
    events:
      - pull_request
      - tag
    branch_patterns:
      - pattern: develop
        include: true
        source: false
    tag_patterns:
      - pattern: feat/simplex-3
        include: true
    cancel_previous_builds: false  

  stage_triggering: &stage_triggering
    events:
      - push
    branch_patterns:
      - pattern: develop
        include: true
        source: false
    cancel_previous_builds: false    
  
  prod_triggering: &prod_triggering
    events:
      - tag
    tag_patterns:
      - pattern: master
        include: true
    cancel_previous_builds: false  

workflows:
  flavor_development_target_stage:
    name: Flavor (Development) Target (Stage)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_stage.dart"
        <<: *flavor_development_vars

      <<: *flavor_development_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts
    triggering: *dev_triggering 

  flavor_development_target_production:
    name: Flavor (Development) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_development_vars

      <<: *flavor_development_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts
  
  flavor_stage_target_stage:
    name: Flavor (Stage) Target (Stage)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_stage.dart"
        <<: *flavor_staging_vars

      <<: *flavor_staging_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts

  flavor_stage_target_production:
    name: Flavor (Stage) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_staging_vars

      <<: *flavor_staging_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts
    triggering: *stage_triggering

  flavor_production_target_stage:
    name: Flavor (Production) Target (Stage)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_stage.dart"
        <<: *flavor_production_vars

      <<: *flavor_production_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts
  
  flavor_production_target_production:
    name: Flavor (Production) Target (Production)
    <<: *build_config

    environment:
      vars:
        MAIN_TARGET: "lib/main_production.dart"
        <<: *flavor_production_vars

      <<: *flavor_production_groups
      <<: *versioning

    cache: *cache
    scripts: *scripts
    publishing: *publishing
    artifacts: *artifacts
    triggering: *prod_triggering